/*! ajaxUpload - v0.1.0 - 2015-08-18
* https://github.com/xiyuyizhi/ajaxUpload
* Copyright (c) 2015 xiyuyizhi; Licensed MIT */
!function(a){function b(){function a(){var a;return a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),console.log("[object XMLHttpRequest]"==Object.prototype.toString.call(a)),a}var b;return function(){return b||(b=a())}}function c(a,b){for(var c=a.split(","),d=0;d<c.length;d++)if(c[d].toLowerCase()==b)return!0;return!1}function d(a){return a/1024/1024>1?(a/1024/1024).toFixed(2)+"Mkb":(a/1024).toFixed(2)+"KB"}function e(){var a="";return a+="<div id='uploadProcess'>",a+="<p class='head gradientHead'>",a+="<span class='headMsg'>上传中</span>",a+="<span class='menu'>",a+="<span class='minimize'></span>",a+="<span class='maximize'></span>",a+="<span class='close'>X</span>",a+="</span>",a+="</p>",a+="<ul class='processUl'>",a+="</ul>",a+="</div>"}function f(){m=a("#uploadProcess"),j=a("#uploadProcess .minimize"),k=a("#uploadProcess .maximize"),l=a("#uploadProcess .close"),j.live("click",function(){m.css("height","50px"),j.css("display","none"),k.css("display","block")}),k.live("click",function(){m.css("height","400px"),j.css("display","block"),k.css("display","none")}),l.live("click",function(){m.css("display","none"),a(".processUl").html(""),s=0})}function g(b,e){for(var f,g,h=a(".processUl"),i="",j=0;j<b.length;j++)i+=j==b.length-1?"<li class='lastLi'>":"<li>",i+="<div class='processDiv gradientProcess'></div>",i+="<span class='title'>"+b[j].name+"</span>",i+="<span class='size'>"+d(b[j].size)+"</span>",c(e,b[j].type)?(i+="<span class='percent'></span>",i+="<span class='status cancel' title='取消'></span>"):(i+="<span class='percent' style='visibility:visible'>已取消</span>",i+="<span class='status cancel' title='取消' style='display:none'></span>"),i+="</li>";h.append(i),a("#uploadProcess .headMsg").html("上传中"),p=a(".processUl li"),r=p.width(),n=a("#uploadProcess .percent"),q=a("#uploadProcess .status"),f=h.height(),g=p.height(),f<g*p.length?h.css("overflow-y","scroll"):h.css("overflow-y","hidden")}function h(a,b,c){console.log("width:"+r);var d=a/b;o=p.eq(c).find(".processDiv"),n.eq(c).css("visibility","visible"),n.eq(c).html((a/b*100).toFixed(2)+"%"),o.css("width",d*parseInt(r)+"px")}function i(b,c,d,e,f){var g=b(),i=q.eq(d);if(o=p.eq(d).find(".processDiv"),g.upload){g.open(f.method,f.url,!0);var l=new FormData;l.append("file",c),g.send(l),g.onreadystatechange=function(b){4==g.readyState&&(200==g.status?(n.eq(d).css("visibility","hidden"),o.hide(),i.removeClass("cancel").addClass("ok"),i.unbind(),d==e-1&&(a("#uploadProcess .headMsg").html("上传完成"),f.complete(),setTimeout(function(){a("#uploadProcess").css("height","50px"),j.css("display","none"),k.css("display","block")},500)),f.success(c,g)):f.error(c,g))},g.upload.addEventListener("progress",function(a){h(a.position,a.totalSize,d)},!1),i.bind("click",function(){g.abort(),o.hide(),i.hide(),a("#uploadProcess .percent").eq(d).html("已取消"),console.log("取消上传成功")})}}var j,k,l,m,n,o,p,q,r,s=0;a.fn.extend({upload:function(d){function h(a){var d=a.target.files;console.log(d);var e;if(d.length>l.maxFileCount)return void alert("最多只能上传"+l.maxFileCount+"个文件！");g(d,l.allowSuffix),m.show(),k.click();for(var f=0;f<d.length;f++)c(l.allowSuffix,d[f].type)?(e=b(),console.log(d[f]),i(e,d[f],f+s,d.length+s,l)):alert(d[f].name+" 文件格式不允许！");s+=d.length}var j={url:"/",method:"POST",maxFileCount:"10",allowSuffix:"image/png,image/jpeg,text/plain,application/msword",success:function(){},error:function(){},complete:function(){}},l=a.extend(j,d),n=e();a("body").append(n),f(),this.each(function(b,c){a(this).after("<input type='file' name='file' multiple style='visibility: hidden'>"),a(this).click(function(){a("input[type=file]").click()}),a("input[type=file]").on("change",h)})}})}(jQuery);