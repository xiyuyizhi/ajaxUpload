/*! ajaxUpload - v0.1.0 - 2015-11-30
* https://github.com/xiyuyizhi/ajaxUpload
* Copyright (c) 2015 xiyuyizhi; Licensed MIT */
!function(a){function b(){function a(){var a;return a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),console.log("[object XMLHttpRequest]"==Object.prototype.toString.call(a)),a.withCredentials=!0,a}var b;return function(){return b||(b=a())}}function c(a,b){for(var c=a.split(","),d=0;d<c.length;d++)if(c[d].toLowerCase()==b)return!0;return!1}function d(a){return a/1024/1024>1?(a/1024/1024).toFixed(2)+"Mkb":(a/1024).toFixed(2)+"KB"}function e(){var a="";return a+="<div id='uploadProcess'>",a+="<p class='head gradientHead'>",a+="<span class='headMsg'>上传中</span>",a+="<span class='menu'>",a+="<span class='minimize'></span>",a+="<span class='maximize'></span>",a+="<span id='close'>X</span>",a+="</span>",a+="</p>",a+="<ul class='processUl'>",a+="</ul>",a+="</div>"}function f(b){m=a("#uploadProcess"),j=a("#uploadProcess .minimize"),k=a("#uploadProcess .maximize"),l=a("#uploadProcess #close"),j.on("click",function(){m.css("height","50px"),j.css("display","none"),k.css("display","block")}),k.on("click",function(){m.css("height","400px"),j.css("display","block"),k.css("display","none")}),l.on("click",function(){m.css("display","none"),a(".processUl").html(""),b.length=0})}function g(b,e){for(var f,g,h=a("#uploadProcess .processUl"),i="",j=0;j<b.length;j++)i+=j==b.length-1?"<li class='lastLi'>":"<li>",i+="<div class='processDiv gradientProcess'></div>",i+="<span class='title'>"+b[j].name+"</span>",i+="<span class='size'>"+d(b[j].size)+"</span>",c(e,b[j].type)?(i+="<span class='percent'></span>",i+="<span class='status cancel' title='取消'></span>"):(i+="<span class='percent' style='visibility:visible'>已取消</span>",i+="<span class='status cancel' title='取消' style='display:none'></span>"),i+="</li>";h.append(i),a("#uploadProcess .headMsg").html("上传中"),p=a(".processUl li"),r=a("#uploadProcess").width(),n=a("#uploadProcess .percent"),q=a("#uploadProcess .status"),f=h.height(),g=p.height(),f<g*p.length?h.css("overflow-y","scroll"):h.css("overflow-y","hidden")}function h(a,b,c){var d=a/b;o=p.eq(c).find(".processDiv"),n.eq(c).css("visibility","visible"),n.eq(c).html((a/b*100).toFixed(2)+"%"),o.css("width",d*parseInt(r)+"px")}function i(b,c,d,e,f){var g=b(),i=q.eq(d);if(g.upload){g.upload.addEventListener("progress",function(a){h(a.position,a.totalSize,d)},!1),g.onreadystatechange=function(b){4==g.readyState&&(200==g.status?(o=p.eq(d).find(".processDiv"),o.hide(),n.eq(d).css("visibility","hidden"),i.removeClass("cancel").addClass("ok"),i.unbind(),s--,s||(a("#uploadProcess .headMsg").html("上传完成"),f.complete(),setTimeout(function(){a("#uploadProcess").css("height","50px"),j.css("display","none"),k.css("display","block")},500)),f.success(c,g)):f.error(c,g))},g.open(f.method,f.url,!0);var l=new FormData;l.append("file",c),g.send(l),i.bind("click",function(){g.abort(),o.hide(),i.hide(),a("#uploadProcess .percent").eq(d).html("已取消"),a("#uploadProcess .headMsg").html("已取消"),j.click(),console.log("取消上传成功")})}}var j,k,l,m,n,o,p,q,r,s;a.fn.extend({upload:function(d){function h(d,e){var f=d.target.files;console.log("文件列表");var h;if(0==f.length)return!1;if(f.length>e.maxFileCount)return void alert("一次最多只能上传"+e.maxFileCount+"个文件！");g(f,e.allowSuffix),m.show(),k.click(),s=f.length;for(var n=0;n<f.length;n++)c(e.allowSuffix,f[n].type)?(h=b(),console.log(f[n]),i(h,f[n],n+l.length,f.length+l.length,e)):(alert(f[n].name+" 文件格式不允许！"),a("#uploadProcess .headMsg").html("已取消"),j.click());l.length+=f.length}var l={length:0},n={url:"/",method:"POST",maxFileCount:"10",allowSuffix:"image/png,image/jpeg",success:function(){},error:function(){},complete:function(){}};this.each(function(b,c){!function(b){a("#uploadProcess").remove();var d=e();a("body").append(d),f(l),a("input[type=file]").remove(),0===a("input[type=file]").length&&(a(c).after("<input type='file' name='fileselect[]' multiple style='display: none;'>"),a("input[type=file]").on("change",function(c){var d=c||window.event,e=a.extend(n,b);h(d,e),d.target.value=""})),a(c).next().css({height:"0"}),a(c).off("click"),a(c).on("click",function(){a("input[type=file]").click()})}(d)})}})}(jQuery);